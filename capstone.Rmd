---
title: "Capstone"
author: "Bianca Rodas"
date: "2025-04-16"
output: html_document
---

```{r libraries}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(viridis)
```


```{r read-in-data, eval=FALSE}
m1 <- read_csv("raw-data/master_m1.csv")
m2 <- read_csv("raw-data/master_m2.csv")
c1 <- read_csv("raw-data/master_c1.csv")
```

```{r cleaning-data, eval=FALSE}
m1 <- m1 |>
  mutate(buoy_id = "M1") |> #new column
  mutate(year = format(date, "%Y"), #new column by extracting year from POSIX format
         month = format(date, "%m"),
         day = format(date, "%d"))

m2 <- m2 |> 
  mutate(buoy_id = "M2")|> 
  mutate(year = format(date, "%Y"),
         month = format(date, "%m"),
         day = format(date, "%d"))

c1 <- c1 |>
  mutate(buoy_id = "C1")|> 
  mutate(year = format(date, "%Y"),
         month = format(date, "%m"),
         day = format(date, "%d"))

all_sites <- bind_rows(m1, m2, c1) #stacked each dataframe on top of each other

all_sites <- all_sites |> 
  mutate(enso_event = case_when(mei >= -0.5 & mei <= 0.5 ~ "Neutral",
                                TRUE ~ enso_event),#new variable called "Neutral" for certain years
         upwelling = if_else((direction >= 280.5 & direction <= 330.5 )& speed > 4.0, 1, 0)) |> #new column called upwelling based on certain conditions
  mutate(year = as.numeric(year), # changed variables from character to numeric
         month =as.numeric(month),
         day = as.numeric(day),
         week = ceiling(day(date) / 7))


#write_csv(all_sites, "clean-data/master.csv") # downloads a csv from cleaned data
```


```{r read-in-master-data}
master <- read_csv("clean-data/master.csv")
```

```{r}
heat_data <- master |>
  group_by(enso_event, month) |>
  summarise(upwelling_count = sum(upwelling, na.rm = TRUE),
            prop_upwelling = mean(upwelling, na.rm = TRUE), .groups = "drop")

master$enso_event <- factor(master$enso_event, 
                                        levels = c("Neutral", "El Nino", "La Nina")) 
  
```


## Visualizations 


```{r}
# Create heatmap by counts of upwelling events per month
ggplot(heat_data, aes(x = factor(month, levels = 1:12), 
                      y = enso_event, 
                      fill = upwelling_count)) +
  geom_tile(color = "white") +
  scale_fill_viridis() +
  labs(title = "Monthly Upwelling Count by ENSO Event",
       x = "Months", 
       y = "ENSO Events",
       color= "Upwelling Count") +
  theme_classic()

```


```{r}
# Create heatmap by proportions of upwelling events per month
ggplot(heat_data, aes(x = factor(month, levels = 1:12), y = enso_event, fill = prop_upwelling)) +
  geom_tile(color = "white") +
  scale_fill_viridis(name = "Upwelling Prop") +
  labs(x = "Month", 
       y = "ENSO Event", 
       title = "Monthly Upwelling Proportion by ENSO Event",
       caption= str_wrap("Figure. Heatmap of proportion of months with upwelling events across different ENSO phases (El Niño, La Niña, and Neutral) and calendar months. Each tile represents the fraction of months—aggregated across multiple years—in which upwelling occurred during a specific ENSO condition and month. Yellow tiles indicate a higher proportion of upwelling months (closer to 1.0), while purple tiles indicate lower proportions.",
                         width = 108)) +
  theme_classic()+
  theme(plot.caption = element_text(size = 9,
                                    hjust = 0,
                                    margin = margin(t = 10)))

#ggsave(filename = "figures/upwelling_heatmap.png")
```





## Analysis











